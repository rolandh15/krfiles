name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

permissions:
  contents: read

jobs:
  check-versions:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check VERSION matches Cargo.toml
        run: |
          VERSION=$(cat VERSION)
          CARGO_VERSION=$(grep '^version' cli/Cargo.toml | head -1 | sed 's/.*"\(.*\)".*/\1/')
          if [ "$VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::VERSION file ($VERSION) does not match cli/Cargo.toml ($CARGO_VERSION)"
            exit 1
          fi

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install libcurl (for Kotlin/Native Curl engine)
        run: sudo apt-get install -y libcurl4-openssl-dev

      - name: Run unit tests (JVM, JS, Native)
        run: ./gradlew unitTest

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            lib/build/reports/tests/
            lib/build/test-results/

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run ktlint check
        run: ./gradlew ktlintCheck

  rust-fmt:
    name: Rust Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        working-directory: cli
        run: cargo fmt --check

  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install libcurl (for Kotlin/Native Curl engine)
        run: sudo apt-get install -y libcurl4-openssl-dev

      - name: Run unit tests with coverage instrumentation
        run: ./gradlew unitTest

      - name: Generate coverage report
        run: ./gradlew koverHtmlReport koverXmlReport -x jvmIntegrationTest

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: lib/build/reports/kover/

  build-native:
    name: Native Library (${{ matrix.target }})
    needs: [test, lint]
    strategy:
      matrix:
        include:
          - target: linux-x64
            os: ubuntu-latest
            gradle-task: linkKrfilesReleaseSharedLinuxX64
            artifact-path: lib/build/bin/linuxX64/krfilesReleaseShared/
          - target: linux-arm64
            os: ubuntu-latest
            gradle-task: linkKrfilesReleaseSharedLinuxArm64
            artifact-path: lib/build/bin/linuxArm64/krfilesReleaseShared/
          - target: macos-x64
            os: macos-latest
            gradle-task: linkKrfilesReleaseSharedMacosX64
            artifact-path: lib/build/bin/macosX64/krfilesReleaseShared/
          - target: macos-arm64
            os: macos-latest
            gradle-task: linkKrfilesReleaseSharedMacosArm64
            artifact-path: lib/build/bin/macosArm64/krfilesReleaseShared/
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Install libcurl (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get install -y libcurl4-openssl-dev

      - name: Build native shared library
        run: ./gradlew ${{ matrix.gradle-task }}

      - name: Upload native shared library
        uses: actions/upload-artifact@v4
        with:
          name: krfiles-native-${{ matrix.target }}
          path: ${{ matrix.artifact-path }}

  build-jvm-js:
    name: Build JVM + JS
    needs: [test, lint]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build JVM jar
        run: ./gradlew jvmJar

      - name: Pack npm package
        run: ./gradlew npmPack

      - name: Upload JVM jar
        uses: actions/upload-artifact@v4
        with:
          name: krfiles-jvm
          path: lib/build/libs/*.jar

      - name: Upload npm package
        uses: actions/upload-artifact@v4
        with:
          name: krfiles-npm
          path: lib/build/dist/js/productionLibrary/*.tgz

  rust-build:
    name: Rust Build (${{ matrix.target }})
    needs: [test, lint]
    strategy:
      matrix:
        include:
          - target: linux-x64
            os: ubuntu-latest
            gradle-task: linkKrfilesReleaseSharedLinuxX64
            kotlin-target: linuxX64
            cargo-target: ''
          - target: macos-arm64
            os: macos-latest
            gradle-task: linkKrfilesReleaseSharedMacosArm64
            kotlin-target: macosArm64
            cargo-target: ''
          - target: macos-x64
            os: macos-latest
            gradle-task: linkKrfilesReleaseSharedMacosX64
            kotlin-target: macosX64
            cargo-target: x86_64-apple-darwin
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install libcurl (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get install -y libcurl4-openssl-dev

      - name: Add Rust cross-compilation target
        if: matrix.cargo-target != ''
        run: rustup target add ${{ matrix.cargo-target }}

      - name: Build Kotlin native shared library
        run: ./gradlew ${{ matrix.gradle-task }}

      - name: Copy C header to CLI
        run: cp lib/build/bin/${{ matrix.kotlin-target }}/krfilesReleaseShared/libkrfiles_api.h cli/native/

      - name: Run clippy
        working-directory: cli
        run: cargo clippy ${{ matrix.cargo-target != '' && format('--target {0}', matrix.cargo-target) || '' }} -- -D warnings

      - name: Build Rust CLI
        working-directory: cli
        run: cargo build --release ${{ matrix.cargo-target != '' && format('--target {0}', matrix.cargo-target) || '' }}

      - name: Upload Rust CLI
        uses: actions/upload-artifact@v4
        with:
          name: krfiles-cli-${{ matrix.target }}
          path: cli/target/${{ matrix.cargo-target != '' && format('{0}/release/krfiles', matrix.cargo-target) || 'release/krfiles' }}
